<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ePhotosynthesis: Conversion from Matlab to C++</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<script type="text/javascript" src="../../clipboard.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../cookie.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">ePhotosynthesis
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(1); });
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('d8/ddf/conversion.html','../../'); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Conversion from Matlab to C++</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md__2home_2runner_2work_2e_photosynthesis___c_2e_photosynthesis___c_2docs_2conversion"></a></p>
<p>The <a class="el" href="../../d0/d3a/namespacee_photosynthesis.html">ePhotosynthesis</a> code was originally written in Matlab. It was converted to C++ to make it faster and more portable. The conversion was done using both scripts and manual coding. The <a href="../../convert.py">convert.py</a> script was used to handle the bulk of the conversion.</p>
<h2><a class="anchor" id="autotoc_md0"></a>
Process</h2>
<p>The script to do the initial conversion looks for all files in the current directory that have the suffix '.m'. It the makes multiple passes through all of the files, gathering information and refining the code. Before the script is run, any files which do plotting in Matlab need to be manually deleted, as currently the C++ code does not support the plotting functionality.</p>
<p>During the conversion process it was assumed that all variables were double precision or an array of double precision items, unless:</p><ul>
<li>The variable was only used in comparisons in <code>if</code> statements and was the only thing on its side of the comparator, then it is assumed to be a boolean</li>
<li>The variable was only used for counting or as an index, then it is assumed to be a size_t or int</li>
</ul>
<h3><a class="anchor" id="autotoc_md1"></a>
Automated</h3>
<p>During the passes through the code the script does the following:</p><ul>
<li>Replace the Matlab comment (%) with the C++ version (//)</li>
<li>Remove extraneous spaces (e.g., no spaces before a terminating ';')</li>
<li>Properly space around operators, parenthses, and brackets</li>
<li>Locate function definitions, gathering arguments and return values</li>
<li>Locate global variables (there are 450+ of them)<ul>
<li>Determine if any of the variables is an array by looking at any assignment operations</li>
</ul>
</li>
<li>Locate calls to the ODE solver</li>
<li>Locate local variables<ul>
<li>Determine if any of the variables is an array</li>
</ul>
</li>
<li>Find function calls to determine the data types of the arguments and track where each function is called</li>
<li>Track where and how often local and global variables are used</li>
<li>Convert from <code>^</code> to <code>pow()</code></li>
<li>Determine which local and global variables are constants (i.e., only have a single assignment call)</li>
<li>Convert from Matlab to C++ array formats<ul>
<li><code>()</code> to <code>[]</code></li>
<li>Assignments that used <code>:</code> notation are converted to for loops over the appropriate indices</li>
<li>Indices are decremented to convert from the Matlab 1 based indexing to the C++ 0 based</li>
</ul>
</li>
<li>Convert uses of global variables to be members of a single <code>struct</code></li>
<li>Convert <code>if</code> statements, done recursively for nested statements</li>
<li>Convert for loops, done recursively for nested statements</li>
<li>Add instantiations to local variables (<code>const double</code>, <code>double</code>, etc.) to the first assignment statement</li>
<li>Comment out any unused local and global variables (unused variables are those that only have assignment statements and no statements where the variables is used otherwise)</li>
<li>Run a consistency check on all function calls to make sure all function calls have the correct number of arguments<ul>
<li>Any calls that do not have the correct number of arguments (based on the API of the function) are flagged</li>
<li>Any files with flagged calls are deleted</li>
<li>Check that the functions defined in the deleted files are not called by any other code</li>
</ul>
</li>
<li>Write out the C++ files</li>
<li>Generate a header with all function signatures and the global data structure</li>
</ul>
<h3><a class="anchor" id="autotoc_md2"></a>
Manual</h3>
<p>Once the script completes it is unlikely that the code will compile as there will be corner cases which the script did not see due to its strict pattern matching parameters. Strict pattern matching was chosen as it would be much less likely to produce broken code when compared to overly inclusive pattern matching. The following were done manually afterward:</p>
<ul>
<li>Many variable assignments were deemed to be unneeded and were simplified. <div class="fragment"><div class="line">double var1 = input1;</div>
<div class="line"> </div>
<div class="line">double newvar = var1;</div>
</div><!-- fragment --> would be converted to <div class="fragment"><div class="line">double newvar = input1;</div>
</div><!-- fragment --> and <div class="fragment"><div class="line">double var1 = input1 * 3.5;</div>
<div class="line"> </div>
<div class="line">double newvar = var2 * 8 * var1;</div>
</div><!-- fragment --> would be converted to <div class="fragment"><div class="line">double newvar = var2 * 8 * input1 * 3.5;</div>
</div><!-- fragment --> but <div class="fragment"><div class="line">double var1 = input1 * 3.5;</div>
<div class="line"> </div>
<div class="line">double newvar = var2 * 8 * var1;</div>
<div class="line">double newvar2 = 18.3 * var1;</div>
</div><!-- fragment --> would not change because the original assignment of <code>var1</code> included a math operation and <code>var1</code> was used more than once.</li>
<li>Input data and result data from the Rate calculations were does with arrays in Matlab. However, tracing a single element of an array can be very tedious as the multiple output arrays are re-ordered and combined from the many Rate calculations. Thus in the C++ code these were converted to classes so that each variable can be traced much easier. As the ODE solver uses array like structures to pass the input to, and output from, the code it is evaluating, these classes have to be flattened into a single array for this purpose. Each class is responsible for converting its own data members into the appropriate array.</li>
<li>The header was broken up into a single header for each 'module'. A module is defined as all code associated with a Rate calculation (e.g., <a class="el" href="../../d7/dde/_b_f___ini_8cpp.html">BF_Ini.cpp</a>, <a class="el" href="../../d8/d36/_b_f___m_b_8cpp.html">BF_Mb.cpp</a>, and <a class="el" href="../../d5/d01/_b_f___rate_8cpp.html">BF_Rate.cpp</a> would all be part of the BF module). Each module is technically a class containing all the code for the module.</li>
<li>All global variables were evaluated to see if they were only used in a single module. If they were they were moved to the module class, this greatly reduced the memory footprint of the global data structure (now only ~150 variables).</li>
<li>The 2D arrays that are used to track the intermediate results were converted to TimeSeries objects to make indexing easier and reduce the number of lines of code</li>
<li>The use of these tracking data structures can be triggered with a command line argument (using the tracking can increase the run time of the code by a factor of 100)</li>
<li>Command line arguments were added to give the user control over the time steps that the calculations use</li>
</ul>
<p>The data that are passed to the ODE solver as the current values are held in arrays in both the Matlab and C++ code. The Matlab code always kept these as arrays, access by the index number. This can make it very cumbersome to track individual variables through the code. In the C++ version of the code these data arrays were converted to container classes with named variables in place of the indexes, making it much easier to track individual variables. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../index.html">Documentation</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
